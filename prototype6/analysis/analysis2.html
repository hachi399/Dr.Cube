<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>Analysis Page</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    img { max-width: 100%; border-radius: 12px; }
  </style>
</head>
<body>
  <h2>解析ページ</h2>
  <p>カメラページから送られた画像を表示しています。</p>

  <div id="preview">画像を読み込み中…</div>

<script>
// ============================================
//  URL の ?id= を取得
// ============================================
const params = new URL(location.href).searchParams;
const imageId = Number(params.get("id"));

if (!imageId) {
  document.getElementById("preview").innerHTML = "画像 ID がありません。";
}

// ============================================
// IndexedDB の画像を読み出す処理
// ============================================
const DB = 'camera-db';
const STORE = 'images';
let db;

function openDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB, 1);
    req.onupgradeneeded = () => {
      req.result.createObjectStore(STORE, { keyPath:'id', autoIncrement:true });
    };
    req.onsuccess = () => { db = req.result; resolve(); };
    req.onerror = () => reject();
  });
}

async function loadImageFromDB(id) {
  await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE, 'readonly');
    const store = tx.objectStore(STORE);
    const req = store.get(id);

    req.onsuccess = () => resolve(req.result);
    req.onerror  = () => reject();
  });
}

// ============================================
// 画像を復元して表示
// ============================================
(async () => {
  const item = await loadImageFromDB(imageId);

  if (!item) {
    document.getElementById("preview").innerHTML = "画像が見つかりません。";
    return;
  }

  const blob = item.blob;
  const url = URL.createObjectURL(blob);

  document.getElementById("preview").innerHTML =
    `<img src="${url}"><p>画像 ID: ${imageId}</p>`;
})();
</script>
</body>
</html>
