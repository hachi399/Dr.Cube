<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Camera Capture â†’ IndexedDB / Cloud</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; display:flex; gap:20px; padding:20px; }
    .left{ flex:1; max-width:640px; }
    video, canvas { width:100%; border-radius:12px; background:#000; }
    .controls { margin-top:10px; display:flex; gap:8px; }
    button { padding:10px 14px; border-radius:10px; border:0; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,0.15); }
    .gallery { width:320px; max-height:80vh; overflow:auto; border-left:1px solid #eee; padding-left:16px; }
    .thumb { width:100%; margin-bottom:12px; border-radius:8px; }
  </style>
</head>
<body>
  <div class="left">
    <h2>ã‚«ãƒ¡ãƒ©</h2>
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas" style="display:none"></canvas>
    <div class="controls">
      <button id="captureBtn">ğŸ“¸ ã‚·ãƒ£ãƒƒã‚¿ãƒ¼</button>
      <button id="saveLocalBtn">ğŸ’¾ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜</button>
      <button id="uploadBtn">â˜ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰ã¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
      <label style="margin-left:auto">
        <input id="autoUpload" type="checkbox" /> è‡ªå‹•ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      </label>
    </div>
  </div>

  <div class="gallery">
    <h3>ã‚®ãƒ£ãƒ©ãƒªãƒ¼ï¼ˆIndexedDBï¼‰</h3>
    <div id="thumbs"></div>
  </div>

<script>
/* === ã‚«ãƒ¡ãƒ©èµ·å‹• === */
const video = document.getElementById('video');
async function startCamera() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false });
    video.srcObject = stream;
  } catch (e) {
    alert('ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ: ' + e.message);
  }
}
startCamera();

/* === ã‚­ãƒ£ãƒ—ãƒãƒ£ === */
const canvas = document.getElementById('canvas');
function captureImageBlob() {
  // videoã®ã‚µã‚¤ã‚ºã‚’canvasã«åˆã‚ã›ã‚‹
  canvas.width = video.videoWidth || 1280;
  canvas.height = video.videoHeight || 720;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  return new Promise(resolve => {
    canvas.toBlob(blob => resolve(blob), 'image/jpeg', 0.9);
  });
}

/* === IndexedDB: ã‚·ãƒ³ãƒ—ãƒ«ä¿å­˜/å–å¾— === */
const DB_NAME = 'camera-cache-db';
const STORE = 'images';
let db;
function openDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, 1);
    req.onupgradeneeded = () => {
      req.result.createObjectStore(STORE, { keyPath: 'id', autoIncrement: true });
    };
    req.onsuccess = () => { db = req.result; resolve(db); };
    req.onerror = () => reject(req.error);
  });
}
async function saveToIndexedDB(blob, meta={}) {
  await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE, 'readwrite');
    const store = tx.objectStore(STORE);
    const item = { blob, createdAt: Date.now(), meta };
    const req = store.add(item);
    req.onsuccess = () => { resolve(req.result); displayGallery(); };
    req.onerror = () => reject(req.error);
  });
}
async function getAllFromIndexedDB() {
  await openDB();
  return new Promise((resolve,reject) => {
    const tx = db.transaction(STORE, 'readonly');
    const store = tx.objectStore(STORE);
    const req = store.getAll();
    req.onsuccess = ()=> resolve(req.result);
    req.onerror = ()=> reject(req.error);
  });
}

/* === ã‚®ãƒ£ãƒ©ãƒªãƒ¼è¡¨ç¤º === */
const thumbs = document.getElementById('thumbs');
async function displayGallery() {
  thumbs.innerHTML = '';
  const items = await getAllFromIndexedDB();
  // æœ€æ–°é †
  items.sort((a,b)=>b.createdAt - a.createdAt);
  for (const it of items) {
    const url = URL.createObjectURL(it.blob);
    const img = document.createElement('img');
    img.src = url;
    img.className = 'thumb';
    img.title = new Date(it.createdAt).toLocaleString();
    img.onclick = () => {
      // ã‚¯ãƒªãƒƒã‚¯ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      const a = document.createElement('a');
      a.href = url; a.download = `photo_${it.id}.jpg`; a.click();
    };
    thumbs.appendChild(img);
  }
}

/* === ãƒœã‚¿ãƒ³æ“ä½œ === */
document.getElementById('captureBtn').addEventListener('click', async () => {
  const blob = await captureImageBlob();
  // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ä¸€æ™‚çš„ã«è¡¨ç¤ºï¼ˆä»»æ„ï¼‰
  const win = window.open(URL.createObjectURL(blob), '_blank');
  setTimeout(()=>win?.close(), 1500);
});
document.getElementById('saveLocalBtn').addEventListener('click', async () => {
  const blob = await captureImageBlob();
  await saveToIndexedDB(blob, { source: 'manual' });
  alert('ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜ã—ã¾ã—ãŸ');
});
document.getElementById('uploadBtn').addEventListener('click', async () => {
  const blob = await captureImageBlob();
  await saveToIndexedDB(blob, { source: 'upload-click' });
  // cloudUploadã¯ä»¥ä¸‹ã§å®šç¾©ï¼ˆFirebase/S3ãã‚Œãã‚Œã®å®Ÿè£…ã«å·®ã—æ›¿ãˆï¼‰
  try {
    await cloudUploadBlob(blob);
    alert('ã‚¯ãƒ©ã‚¦ãƒ‰ã¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
  } catch (e) {
    alert('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—: ' + e.message);
  }
});
document.getElementById('autoUpload').addEventListener('change', (e) => {
  // è‡ªå‹•ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ï¼šã‚·ãƒ£ãƒƒã‚¿ãƒ¼ç›´å¾Œã«è‡ªå‹•ã§ã‚¯ãƒ©ã‚¦ãƒ‰ã«é€ã‚‹
});

/* è‡ªå‹•å‡¦ç†ã‚µãƒ³ãƒ—ãƒ«ï¼šã‚·ãƒ£ãƒƒã‚¿ãƒ¼ã‚’æŠ¼ã—ãŸã‚‰è‡ªå‹•ã§ä¿å­˜ï¼‹ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ */
async function captureSaveMaybeUpload() {
  const blob = await captureImageBlob();
  await saveToIndexedDB(blob, { source: 'auto' });
  if (document.getElementById('autoUpload').checked) {
    try { await cloudUploadBlob(blob); } catch(e){ console.warn('auto upload fail', e); }
  }
}
// ä¾‹ï¼šãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§è‡ªå‹•ä¿å­˜+ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
video.addEventListener('dblclick', captureSaveMaybeUpload);

/* åˆæœŸã‚®ãƒ£ãƒ©ãƒªãƒ¼èª­ã¿è¾¼ã¿ */
openDB().then(displayGallery).catch(e=>console.warn(e));

/* === ã‚¯ãƒ©ã‚¦ãƒ‰ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã®ã€Œå‘¼ã³å‡ºã—å…ˆã€é–¢æ•°ï¼ˆå…·ä½“å®Ÿè£…ã¯ä¸‹ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³å‚ç…§ï¼‰ === */
async function cloudUploadBlob(blob) {
  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ã€Œãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«POSTã—ã¦ä¿å­˜ã€ã™ã‚‹å®Ÿè£…ã®æƒ³å®š
  // ã“ã“ã§ã¯ fetch ã§ /upload ã«é€ã‚‹ä¾‹ã€‚
  // ã‚‚ã— Firebase ã‚’ä½¿ã†ãªã‚‰ã€Firebase SDK ã‚’ä½¿ã£ã¦ç›´æ¥ Storage ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚
  const form = new FormData();
  form.append('file', blob, 'photo.jpg');
  const res = await fetch('/upload', { method: 'POST', body: form });
  if (!res.ok) throw new Error('upload failed: ' + res.statusText);
  return res.json(); // { url: 'https://...' } ãªã©
}
</script>
</body>
</html>
