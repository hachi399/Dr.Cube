<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Camera App</title>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        video, canvas { width: 100%; max-width: 400px; border: 1px solid #ccc; border-radius: 10px; }
        .thumb { width: 100px; height: 100px; object-fit: cover; margin: 5px; border-radius: 5px; cursor: pointer; }
        #gallery { display: flex; flex-wrap: wrap; }
        button { margin: 5px; padding: 10px 20px; }
    </style>
</head>
<body>

<h2>ğŸ“¸ ã‚«ãƒ¡ãƒ©ã‚¢ãƒ—ãƒª</h2>

<button id="toggleCamera">ã‚«ãƒ¡ãƒ© ON</button>
<button id="captureBtn" disabled>ã‚·ãƒ£ãƒƒã‚¿ãƒ¼</button>

<video id="video" autoplay playsinline></video>
<canvas id="canvas" style="display:none;"></canvas>

<h3>ğŸ“‚ ä¿å­˜æ¸ˆã¿ç”»åƒ</h3>
<div id="gallery"></div>

<script>
// ===== IndexedDB åˆæœŸåŒ– =====
let db;
const request = indexedDB.open("CameraImagesDB", 1);

request.onupgradeneeded = (event) => {
    db = event.target.result;
    if (!db.objectStoreNames.contains("images")) {
        db.createObjectStore("images", { keyPath: "id", autoIncrement: true });
    }
};

request.onsuccess = (event) => {
    db = event.target.result;
    loadGallery();
};

request.onerror = () => {
    console.error("IndexedDB error");
};

// ===== ã‚«ãƒ¡ãƒ© ON/OFF =====
let stream;
const video = document.getElementById("video");
const toggleBtn = document.getElementById("toggleCamera");
const captureBtn = document.getElementById("captureBtn");

toggleBtn.onclick = async () => {
    if (!stream) {
        stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
        toggleBtn.textContent = "ã‚«ãƒ¡ãƒ© OFF";
        captureBtn.disabled = false;
    } else {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
        video.srcObject = null;
        toggleBtn.textContent = "ã‚«ãƒ¡ãƒ© ON";
        captureBtn.disabled = true;
    }
};

// ===== ã‚·ãƒ£ãƒƒã‚¿ãƒ¼ =====
captureBtn.onclick = () => {
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0);

    canvas.toBlob((blob) => {
        saveImage(blob);
    }, "image/jpeg", 0.9);
};

// ===== IndexedDB ã«ä¿å­˜ =====
function saveImage(blob) {
    const tx = db.transaction(["images"], "readwrite");
    const store = tx.objectStore("images");
    const req = store.add({ data: blob, created: Date.now() });

    req.onsuccess = (e) => {
        const id = e.target.result;
        loadGallery();
    };
}

// ===== ã‚®ãƒ£ãƒ©ãƒªãƒ¼èª­ã¿è¾¼ã¿ =====
function loadGallery() {
    const tx = db.transaction(["images"], "readonly");
    const store = tx.objectStore("images");
    const req = store.getAll();

    req.onsuccess = () => {
        const gallery = document.getElementById("gallery");
        gallery.innerHTML = "";
        req.result.forEach((imgObj) => {
            const url = URL.createObjectURL(imgObj.data);
            const img = document.createElement("img");
            img.src = url;
            img.className = "thumb";

            img.onclick = () => {
                // analysis.html ã« id ã ã‘é€ã‚‹
                window.location.href = `analysis.html?id=${imgObj.id}`;
            };

            gallery.appendChild(img);
        });
    };
}
</script>

</body>
</html>
