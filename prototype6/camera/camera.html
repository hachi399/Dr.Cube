<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Extended Camera App</title>
  <style>
    body { font-family: sans-serif; display:flex; gap:20px; padding:20px; }
    video, canvas { width:100%; border-radius:12px; background:#000; }
    button { padding:10px 14px; border-radius:10px; border:0; cursor:pointer; }
    .gallery { width:320px; max-height:80vh; overflow:auto; border-left:1px solid #ddd; padding-left:10px; }
    .thumb { width:100%; margin-bottom:10px; border-radius:8px; cursor:pointer; }
    .selected { outline:4px solid #007bff; }
  </style>
</head>
<body>
  <div style="flex:1;max-width:640px;">
    <h2>ã‚«ãƒ¡ãƒ©</h2>
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas" style="display:none"></canvas>

    <div style="margin-top:10px;display:flex;gap:10px;">
      <button id="cameraToggle">ğŸ”Œ ã‚«ãƒ¡ãƒ©åœæ­¢</button>
      <button id="captureBtn">ğŸ“¸ ã‚·ãƒ£ãƒƒã‚¿ãƒ¼</button>
      <button id="saveLocalBtn">ğŸ’¾ ä¿å­˜</button>
    </div>
  </div>

  <div class="gallery">
    <h3>ã‚®ãƒ£ãƒ©ãƒªãƒ¼</h3>
    <div id="thumbs"></div>
    <button id="sendBtn" style="margin-top:10px;width:100%;">â¡ï¸ é¸æŠç”»åƒã‚’é€ä¿¡</button>
  </div>

<script>
/* === ã‚«ãƒ¡ãƒ©åˆ¶å¾¡ === */
let stream = null;
const video = document.getElementById('video');

async function startCamera() {
  if (stream) return;
  stream = await navigator.mediaDevices.getUserMedia({ video:true, audio:false });
  video.srcObject = stream;
}
function stopCamera() {
  if (!stream) return;
  stream.getTracks().forEach(t => t.stop());
  stream = null;
  video.srcObject = null;
}
startCamera();

/* ON / OFF ãƒˆã‚°ãƒ« */
document.getElementById("cameraToggle").onclick = () => {
  if (stream) {
    stopCamera();
    cameraToggle.textContent = "ğŸ”Œ ã‚«ãƒ¡ãƒ©é–‹å§‹";
  } else {
    startCamera();
    cameraToggle.textContent = "ğŸ”Œ ã‚«ãƒ¡ãƒ©åœæ­¢";
  }
};

/* === ã‚­ãƒ£ãƒ—ãƒãƒ£ === */
const canvas = document.getElementById('canvas');
function captureBlob() {
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext('2d').drawImage(video, 0, 0);
  return new Promise(res => canvas.toBlob(res, 'image/jpeg', 0.9));
}

/* === IndexedDB === */
const DB = 'camera-db'; const STORE = 'images';
let db;
function openDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB,1);
    req.onupgradeneeded = ()=>req.result.createObjectStore(STORE,{keyPath:'id',autoIncrement:true});
    req.onsuccess = ()=>{ db=req.result; resolve(); };
    req.onerror = ()=>reject();
  });
}
async function save(blob) {
  await openDB();
  const tx = db.transaction(STORE,'readwrite');
  tx.objectStore(STORE).add({blob,created:Date.now()});
  tx.oncomplete = showGallery;
}

/* === ã‚®ãƒ£ãƒ©ãƒªãƒ¼è¡¨ç¤ºã¨é¸æŠ === */
let selectedId = null;

async function getAll() {
  return new Promise(res=>{
    const tx = db.transaction(STORE,'readonly');
    const store = tx.objectStore(STORE);
    const req = store.getAll();
    req.onsuccess = ()=>res(req.result);
  });
}

async function showGallery() {
  await openDB();
  const items = await getAll();
  const thumbs = document.getElementById('thumbs');
  thumbs.innerHTML = '';

  items.sort((a,b)=>b.created-a.created);

  for (const it of items) {
    const url = URL.createObjectURL(it.blob);
    const img = document.createElement('img');
    img.src = url;
    img.className = 'thumb';
    img.dataset.id = it.id;

    img.onclick = () => {
      document.querySelectorAll('.thumb').forEach(e=>e.classList.remove('selected'));
      img.classList.add('selected');
      selectedId = it.id;
    };

    thumbs.appendChild(img);
  }
}
openDB().then(showGallery);

/* === ãƒœã‚¿ãƒ³ === */
document.getElementById("captureBtn").onclick = async () => {
  const blob = await captureBlob();
  const url = URL.createObjectURL(blob);
  window.open(url, "_blank");
};
document.getElementById("saveLocalBtn").onclick = async () => {
  const blob = await captureBlob();
  await save(blob);
};

/* === é¸æŠç”»åƒã‚’é€ä¿¡ === */
document.getElementById("sendBtn").onclick = async () => {
  if (!selectedId) return alert("é€ä¿¡ã™ã‚‹ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„");

  // é¸æŠã•ã‚ŒãŸç”»åƒã‚’å–ã‚Šå‡ºã™
  const all = await getAll();
  const item = all.find(x => x.id == selectedId);
  if (!item) return alert("ç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");

  // Blob â†’ Base64
  const base64 = await blobToBase64(item.blob);

  // é·ç§»URLï¼ˆGET ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼‰
  const sendUrl =
    "https://hachi399.github.io/Dr.Cube/prototype6/analysis/analysis.html" +
    "?image=" + encodeURIComponent(base64);

  // ãƒšãƒ¼ã‚¸ã¸é·ç§»ï¼ˆPOST ãŒä½¿ãˆãªã„ã®ã§ GET ã§é€ã‚‹ï¼‰
  location.href = sendUrl;
};

function blobToBase64(blob) {
  return new Promise(res=>{
    const r=new FileReader();
    r.onload=()=>res(r.result.split(',')[1]);
    r.readAsDataURL(blob);
  });
}



// === IDã ã‘é€ã£ã¦ analysis.html ã§èª­ã¿è¾¼ã‚€ ===

async function sendSelectedImage(selectedId) {
  if (!selectedId) {
    alert("ç”»åƒãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“");
    return;
  }

  // analysis.html ã¸ç”»åƒIDã‚’æ¸¡ã™
  const url = `https://hachi399.github.io/Dr.Cube/prototype6/analysis/analysis2.html?id=${selectedId}`;
  location.href = url;
}
</script>

</body>
</html>
