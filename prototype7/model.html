<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>カードで連想 — Demo (バグ修正版)</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#06b6d4;--text:#e6eef6}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#071024 0%, #071832 100%);font-family:system-ui,-apple-system,Segoe UI,Roboto,'Hiragino Kaku Gothic ProN',Meiryo,Helvetica,Arial;color:var(--text)}
    .app{height:100vh;display:flex;flex-direction:column;gap:12px;padding:16px}
    header{display:flex;align-items:center;justify-content:space-between}
    h1{font-size:18px;margin:0}
    .controls{display:flex;gap:8px;align-items:center}
    .btn{background:var(--accent);color:#012; padding:8px 10px;border-radius:10px;border:none;cursor:pointer}
    .hint{font-size:12px;opacity:0.8}

    .stage{flex:1;display:flex;align-items:center;overflow:hidden}
    .rail{display:flex;gap:20px;align-items:center;padding:20px;transition:transform .28s ease}

    .card{width:320px;height:460px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.12));border-radius:18px;box-shadow:0 8px 30px rgba(2,6,23,0.6);display:flex;flex-direction:column;overflow:hidden;position:relative;user-select:none}
    .card .media{flex:1;display:flex;align-items:center;justify-content:center;padding:14px}
    .card img{max-width:100%;max-height:100%;border-radius:10px;object-fit:contain}
    .card .meta{padding:12px;background:linear-gradient(180deg, transparent, rgba(0,0,0,0.14));}
    .card .title{font-weight:700;margin:0 0 6px 0}
    .card .text{font-size:14px;line-height:1.45;max-height:110px;overflow:auto;white-space:pre-wrap}
    .overlay-hint{position:absolute;left:8px;top:8px;background:rgba(0,0,0,0.4);padding:6px 8px;border-radius:8px;font-size:12px}
    .ghost{opacity:0.6}

    footer{display:flex;justify-content:center;gap:8px}
    .small{font-size:13px;color:rgba(255,255,255,0.7)}

    /* responsive */
    @media (max-width:760px){.card{width:260px;height:420px}}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>カードで連想 — デモ (バグ修正版)</h1>
      <div class="controls">
        <label class="btn">画像を開く<input id="file" type="file" accept="image/*" style="display:none"></label>
        <button id="addBlank" class="btn">空のカードを追加</button>
      </div>
    </header>

    <div class="stage" id="stage">
      <div class="rail" id="rail" aria-live="polite">
        <!-- cards injected here -->
      </div>
    </div>

    <footer class="small">
      <div>カードを右にスワイプ → 連想カード生成。さらに右にスワイプ → さらに連想。左にスワイプ → 解析カードを生成。</div>
    </footer>
  </div>

  <template id="cardTpl">
    <div class="card">
      <div class="overlay-hint">ドラッグ／スワイプで操作</div>
      <div class="media"><img src="" alt="ユーザー画像" style="display:none"/></div>
      <div class="meta">
        <div class="title">カード</div>
        <div class="text">（内容はここに表示されます）</div>
      </div>
    </div>
  </template>

  <canvas id="tmpCanvas" style="display:none"></canvas>

  <script>
    // --- シンプル実装（バグ修正版） ---
    const rail = document.getElementById('rail');
    const tpl = document.getElementById('cardTpl');
    const fileInput = document.getElementById('file');
    const addBlank = document.getElementById('addBlank');

    // 初期カードを1枚配置
    addCard({title:'最初のカード', text:'画像をアップロードしてください。', image:null});

    fileInput.addEventListener('change', async (e)=>{
      const f = e.target.files[0];
      if(!f) return;
      const url = URL.createObjectURL(f);
      // 置き換え：中央（現在選択カード）に画像をセット
      const activeCard = getActiveCard() || rail.firstElementChild;
      if(!activeCard){
        console.warn('アクティブカードが見つかりません。');
        return;
      }

      // 画像要素が存在するかを確認。なければ作る。
      let imgEl = activeCard.querySelector('img');
      const media = activeCard.querySelector('.media');
      if(!imgEl){
        imgEl = document.createElement('img');
        imgEl.alt = 'ユーザー画像';
        media.appendChild(imgEl);
      }

      // 正しく src をセットし、表示する
      imgEl.src = url;
      imgEl.style.display = '';

      activeCard.dataset.hasImage = '1';
      activeCard.dataset.filename = f.name || '';
      activeCard.dataset.filesize = f.size || 0;
      const titleEl = activeCard.querySelector('.title');
      const textEl = activeCard.querySelector('.text');
      if(titleEl) titleEl.textContent = f.name || '画像カード';
      if(textEl) textEl.textContent = '画像を読み込み中...';

      // 簡易解析を行い、カード本文を更新
      const meta = await analyzeImageFromURL(url, f);
      if(textEl) textEl.textContent = meta.summary;
    });

    addBlank.addEventListener('click', ()=>{
      addCard({title:'空カード', text:'スワイプして連想／解析を生成できます。', image:null});
      centerOnIndex(rail.children.length-1);
    });

    // 追加関数
    function addCard({title='カード', text='', image=null}){
      const node = tpl.content.firstElementChild.cloneNode(true);
      const imgEl = node.querySelector('img');
      if(image && imgEl){
        imgEl.src = image;
        imgEl.style.display = '';
        node.dataset.hasImage = '1';
      }else if(imgEl){
        // 重要: img 要素は削除せず非表示にする -> 他のコードが img を参照しても null にはならない
        imgEl.src = '';
        imgEl.style.display = 'none';
        delete node.dataset.hasImage;
      }

      const titleEl = node.querySelector('.title');
      const textEl = node.querySelector('.text');
      if(titleEl) titleEl.textContent = title;
      if(textEl) textEl.textContent = text;

      // swipe / drag handling
      attachDragHandlers(node);

      rail.appendChild(node);
      // center it
      centerOnIndex(rail.children.length-1);
      return node;
    }

    function getActiveCard(){
      // choose middle-most visible card: simple heuristic pick center index
      const children = Array.from(rail.children);
      if(children.length===0) return null;
      return children[Math.floor(children.length/2)];
    }

    function centerOnIndex(i){
      const first = rail.children[0];
      const cardWidth = first ? (first.getBoundingClientRect().width + 20) : 340;
      const stage = document.getElementById('stage');
      const stageW = stage.getBoundingClientRect().width;
      const offset = (stageW - cardWidth)/2 - i*cardWidth;
      rail.style.transform = `translateX(${offset}px)`;
    }

    // --- ChatGPT API を使った高度解析 ---
async function analyzeImageFromURL(url, file){
  const apiKey = "";
  
  // 画像を Base64 へ変換
  const b64 = await new Promise((res)=>{
    const img = new Image();
    img.crossOrigin = "anonymous";
    img.onload = ()=>{
      const c = document.getElementById('tmpCanvas');
      c.width = img.naturalWidth;
      c.height = img.naturalHeight;
      const ctx = c.getContext('2d');
      ctx.drawImage(img,0,0);
      res(c.toDataURL().split(',')[1]);
    };
    img.src = url;
  });

  const body = {
    model: "gpt-4o-mini",
    messages: [
      {
        role: "user",
        content: [
          { type: "text", text: "この画像を分析して、内容の要約・特徴・連想語を出して。" },
          {
            type: "input_image",
            image_url: `data:image/jpeg;base64,${b64}`
          }
        ]
      }
    ]
  };

  try{
    const res = await fetch("https://api.openai.com/v1/chat/completions",{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Authorization":`Bearer ${apiKey}`
      },
      body:JSON.stringify(body)
    });

    const json = await res.json();
    const text = json.choices?.[0]?.message?.content || "画像解析に失敗しました。";
    return { summary:text };

  }catch(err){
    console.error(err);
    return { summary:"API 通信エラーが発生しました。" };
  }
}

function approxColorName(r,g,b){
      // とても簡易な色名判定
      if(r>200 && g>200 && b>200) return '淡色(明るい)';
      if(r>200 && g<120 && b<120) return '赤系';
      if(g>200 && r<120 && b<120) return '緑系';
      if(b>200 && r<120 && g<120) return '青系';
      if(r>180 && g>120 && b<80) return '黄土色系';
      return '落ち着いた色合い';
    }

    function makeKeywordsFromFilename(name){
      if(!name) return '—';
      const s = name.toLowerCase();
      const parts = s.split(/[^a-z0-9぀-ヿ一-鿿]+/).filter(Boolean);
      if(parts.length===0) return '—';
      return parts.slice(0,3).join('、');
    }

    // --- スワイプ処理 ---
    function attachDragHandlers(card){
      let startX=0, currentX=0, dragging=false, pointerId=null;
      const threshold = 80;

      card.addEventListener('pointerdown', (e)=>{
        try{ card.setPointerCapture(e.pointerId); }catch(_){}
        startX = e.clientX; currentX = startX; dragging=true; pointerId=e.pointerId;
        card.style.transition = 'none';
      });

      card.addEventListener('pointermove', (e)=>{
        if(!dragging || e.pointerId!==pointerId) return;
        currentX = e.clientX;
        const dx = currentX - startX;
        card.style.transform = `translateX(${dx}px) rotate(${dx/20}deg)`;
        card.style.zIndex = 1000;
        card.classList.add('ghost');
      });

      card.addEventListener('pointerup', (e)=>{
        if(!dragging) return;
        dragging=false; try{ card.releasePointerCapture(pointerId);}catch(_){}; pointerId=null;
        const dx = currentX - startX;
        card.style.transition = 'transform .28s ease, opacity .2s ease';
        card.style.zIndex=''; card.classList.remove('ghost');
        card.style.transform = '';

        if(Math.abs(dx) > threshold){
          if(dx>0){
            // 右スワイプ
            handleRightSwipe(card, dx);
          }else{
            // 左スワイプ
            handleLeftSwipe(card, dx);
          }
        }
      });

      // support pointer cancel
      card.addEventListener('pointercancel', ()=>{dragging=false; card.style.transform=''; card.classList.remove('ghost');});

      // double click to open file input for that card
      card.addEventListener('dblclick', ()=>{fileInput.click();});

      // focus styles
    }

    function handleRightSwipe(card,dx){
      const textEl = card.querySelector('.text');
      const hasText = textEl ? textEl.textContent : '';
      // If this card has an image, first right swipe produces association from image
      if(card.dataset.hasImage && !card.dataset.assocDepth){
        const imgUrl = card.querySelector('img')?.src || '';
        const filename = card.dataset.filename || '';
        // create association card to the right
        const assocText = `連想 — この画像から思いついたこと: ${filename ? filename : '（ファイル名なし）' }。色や構図から連想される雰囲気を文章化しています。`;
        const newCard = addCard({title:'連想カード', text:assocText, image:null});
        // mark depth
        card.dataset.assocDepth = 1;
        centerOnIndex(Array.from(rail.children).indexOf(newCard));
        return;
      }

      // if already associated, create deeper association based on existing text
      const base = textEl ? textEl.textContent : '';
      const deeper = deepenAssociation(base);
      const newCard = addCard({title:'さらに連想', text:deeper, image:null});
      // carry assocDepth if present
      const prevDepth = parseInt(card.dataset.assocDepth||0);
      newCard.dataset.assocDepth = prevDepth + 1;
      centerOnIndex(Array.from(rail.children).indexOf(newCard));
    }

    function handleLeftSwipe(card,dx){
      // create an analysis card based on the current card's image or text
      if(card.dataset.hasImage){
        const imgUrl = card.querySelector('img')?.src || '';
        // attempt a more detailed analysis from canvas
        analyzeImageFromURL(imgUrl, {name: card.dataset.filename || '', size: parseInt(card.dataset.filesize||0)}).then(meta=>{
          const text = `解析カード — ${meta.summary} この解析はブラウザ内の簡易アルゴリズムによるものです。`;
          const newCard = addCard({title:'解析カード', text:text, image:null});
          centerOnIndex(Array.from(rail.children).indexOf(newCard));
        });
      }else{
        const base = (card.querySelector('.text') && card.querySelector('.text').textContent) || '';
        const text = `解析カード — テキスト解析結果: 文字数 ${base.length}。語彙のヒント: ${extractKeywords(base)}。`;
        const newCard = addCard({title:'解析カード', text:text, image:null});
        centerOnIndex(Array.from(rail.children).indexOf(newCard));
      }
    }

    function deepenAssociation(text){
      const extras = [
        'ここから感じられる物語性を深掘りすると、登場人物の視点が浮かびます。',
        'さらに展開を考えると、時間軸が前後するドラマ性が生まれます。',
        '色や質感に注目すると、季節や気温の情報が連想できます。',
        '抽象的な比喩を加えると、感情を表現する言葉が増えます。'
      ];
      const pick = extras[Math.floor(Math.random()*extras.length)];
      return text + '\n\n→ さらに連想: ' + pick;
    }

    function extractKeywords(text){
      const words = text.replace(/[\W_]+/g,' ').split(/\s+/).filter(w=>w.length>2);
      return words.slice(0,5).join('、') || '（特になし）';
    }

    // allow clicking on rail to center nearest card
    document.getElementById('stage').addEventListener('click', ()=>{
      // center on last card
      centerOnIndex(rail.children.length-1);
    });

    // resize handler to re-center
    window.addEventListener('resize', ()=>{
      centerOnIndex(Math.max(0,rail.children.length-1));
    });
  </script>
</body>
</html>
